<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study Companion</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
   <style>
    :root {
        --primary-color: #667eea;
        --secondary-color: #764ba2;
        --text-color: #333;
        --background-gradient: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
        --border-radius: 12px;
        --shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        background: var(--background-gradient);
        min-height: 100vh;
        display: flex;
        justify-content: center;
        align-items: center;
        padding: 20px;
    }
    .container {
        background: rgba(255, 255, 255, 0.98);
        backdrop-filter: blur(10px);
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        padding: 30px 40px;
        max-width: 800px;
        width: 100%;
        animation: fadeIn 0.5s ease-out;
        display: flex; flex-direction: column;
    }
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { color: var(--primary-color); font-size: 2.2em; cursor: pointer; }
    .screen { display: none; animation: fadeIn 0.4s ease-out; }
    .screen.active { display: flex; flex-direction: column; gap: 20px; }
    label { display: block; margin-bottom: 8px; color: var(--text-color); font-weight: 600; }
    select, button { width: 100%; padding: 12px; border-radius: 8px; font-size: 1em; }
    select { border: 2px solid #e0e0e0; transition: border-color 0.3s; }
    select:focus { outline: none; border-color: var(--primary-color); }
    button {
        background: var(--background-gradient);
        color: white;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: transform 0.2s, box-shadow 0.2s;
    }
    button:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4); }
    button:disabled { background: #ccc; cursor: not-allowed; }
    .upload-section {
        padding: 20px;
        background: #f0f4ff;
        border-radius: var(--border-radius);
        border: 2px dashed var(--primary-color);
        text-align: center;
    }
    input[type="file"] { display: none; }
    .file-input-label {
        cursor: pointer; padding: 15px; display: block; border-radius: 8px;
        background: white; border: 1px solid #ddd; color: #555;
    }
    #fileNameDisplay { color: var(--primary-color); font-weight: 600; margin: 10px 0; font-size: 0.95em; }
    
    /* FIX: Kompakte Status-Meldungen */
    .status-message { padding: 12px; margin-top: 15px; border-radius: 8px; font-weight: 500; display: none; }
    .status-message.success { background: #e6f9f0; color: #0a7c2e; display: block; }
    .status-message.error { background: #fee; color: #c33; display: block; }
    
    .loading { text-align: center; padding: 40px; }
    .spinner {
        border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
        border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 15px;
    }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    
    /* FIX: Fortschrittsbalken Design */
    .progress-container {
        width: 100%; background-color: #e0e0e0; border-radius: 10px;
        margin-top: 15px; height: 12px; overflow: hidden; display: none;
    }
    .progress-bar { height: 100%; width: 0%; background: var(--background-gradient); transition: width 0.5s ease; }
    
    /* FIX: Analyse-Text unter dem Balken */
    #homeLoadingText { font-size: 0.8em; color: #666; margin-top: 8px; font-style: italic; }

    .results {
        padding: 20px; background: #f8f9fa; border-radius: var(--border-radius);
        border-left: 4px solid var(--primary-color); overflow-y: auto; max-height: 60vh; line-height: 1.7;
    }
    .back-button { width: auto; align-self: flex-start; background: #eef; color: var(--primary-color); border: 2px solid var(--primary-color); }
</style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="appTitle" onclick="goHome()">üéì AI Study Companion</h1>
        </div>

        <div class="screen active" id="homeScreen">
            <div class="upload-section">
                <label for="pdfUpload" class="file-input-label">üìÅ PDF zum Hochladen ausw√§hlen</label>
                <input type="file" id="pdfUpload" accept=".pdf">
                <div id="fileNameDisplay"></div>
                <button id="uploadBtn" onclick="uploadAndProcessFile()">üöÄ Hochladen</button>
                
                <div class="progress-container" id="progressContainer">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                <p id="homeLoadingText"></p> 
            </div>

            <div class="input-group">
                <label for="fileDropdown">Oder vorhandene Datei w√§hlen:</label>
                <select id="fileDropdown"><option value="">Lade Dateien...</option></select>
            </div>
            <button id="analyzeBtn" onclick="analyzeSelectedFile()">üìä Skript analysieren</button>
            <div id="homeStatus" class="status-message"></div>
        </div>

        <div class="screen" id="analysisScreen">
            <button class="back-button" onclick="goHome()">‚Üê Zur√ºck</button>
            <div id="analysisStatus" class="status-message"></div>
            <div class="loading" id="loadingSpinner">
                <div class="spinner"></div>
                <p id="loadingText">Analysiere Dokument...</p>
            </div>
            <div class="results" id="resultsContainer" style="display:none;"></div>
        </div>
    </div>

<script>
    const homeScreen = document.getElementById('homeScreen');
    const analysisScreen = document.getElementById('analysisScreen');
    const pdfUpload = document.getElementById('pdfUpload');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const fileDropdown = document.getElementById('fileDropdown');
    const homeStatus = document.getElementById('homeStatus');
    const analysisStatus = document.getElementById('analysisStatus');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const resultsContainer = document.getElementById('resultsContainer');
    const progressBar = document.getElementById('progressBar');
    const progressContainer = document.getElementById('progressContainer');
    const loadingText = document.getElementById('loadingText');

    document.addEventListener('DOMContentLoaded', loadFiles);
    pdfUpload.addEventListener('change', () => {
        fileNameDisplay.textContent = pdfUpload.files.length > 0 ? `Ausgew√§hlt: ${pdfUpload.files[0].name}` : '';
    });

    function showStatus(element, message, isError = false) {
        element.textContent = message;
        element.className = `status-message ${isError ? 'error' : 'success'}`;
        element.style.display = 'block';
    }

    function goHome() {
        homeScreen.classList.add('active');
        analysisScreen.classList.remove('active');
    }

    async function loadFiles() {
        try {
            const response = await fetch('/files');
            const { files } = await response.json();
            fileDropdown.innerHTML = '<option value="">-- Bitte Datei w√§hlen --</option>';
            files.forEach(f => fileDropdown.add(new Option(f.name, f.path)));
        } catch (error) {
            showStatus(homeStatus, "Fehler beim Laden der Dateien", true);
        }
    }

    // --- GE√ÑNDERTE FUNKTION: Upload & Indexing ---
    async function uploadAndProcessFile() {
        const fileInput = document.getElementById('pdfUpload'); 
        
        if (!fileInput.files || !fileInput.files[0]) {
            showStatus(homeStatus, "Bitte w√§hle erst eine Datei aus.", true);
            return;
        }

        // UI Vorbereitung: Bleibt auf HomeScreen, zeigt nur Progress an
        progressContainer.style.display = 'block';
        homeStatus.style.display = 'none';

        try {
            // PHASE 1: UPLOAD
            updateUI(20, "Lade Datei hoch..."); 

            const formData = new FormData();
            formData.append('file', fileInput.files[0]);

            const response = await fetch('/upload', { method: 'POST', body: formData });
            
            // Verhindert Crash bei 503 Service Unavailable
            if (response.status === 503) throw new Error("Service tempor√§r nicht erreichbar. Bitte kurz warten.");
            const data = await response.json();

            if (!response.ok) throw new Error(data.error || "Upload fehlgeschlagen");

            const gcsUri = data.gcs_uri;

            // PHASE 2: INDIZIERUNG
            let isIndexed = false;
            let attempts = 0;
            const maxAttempts = 30;

            while (!isIndexed && attempts < maxAttempts) {
                attempts++;
                let progress = 20 + (attempts / maxAttempts) * 75;
                updateUI(progress, `Dokument wird indiziert... (Versuch ${attempts}/${maxAttempts})`);
                
                const statusCheck = await fetch('/check_file_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gcs_uri: gcsUri })
                });
                const statusData = await statusCheck.json();

                if (statusData.status === 'INDEXED') {
                    isIndexed = true;
                } else {
                    await new Promise(resolve => setTimeout(resolve, 10000)); 
                }
            }

            if (!isIndexed) throw new Error("Indizierung dauert zu lange. Die Datei erscheint gleich im Dropdown.");

            // FERTIG
            updateUI(100, "Indizierung abgeschlossen! Du kannst die Analyse jetzt starten.");
            await loadFiles(); // Dropdown aktualisieren

        } catch (error) {
            showStatus(homeStatus, error.message, true);
        }
    }

    // --- GE√ÑNDERTE FUNKTION: Startet die Analyse ---
    async function analyzeSelectedFile() {
        const path = fileDropdown.value;
        if (!path) return showStatus(homeStatus, "W√§hle eine Datei", true);

        // Screen wechseln zur Analyse
        homeScreen.classList.remove('active');
        analysisScreen.classList.add('active');
        loadingSpinner.style.display = 'block';
        resultsContainer.style.display = 'none';
        
        // Progressbar auf HomeScreen verstecken
        progressContainer.style.display = 'none';

        try {
            loadingText.textContent = "KI generiert Zusammenfassung...";
            const res = await fetch('/analyze', {
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_path: path })
            });

            // JSON Check (verhindert den "Unexpected token S" Fehler)
            const contentType = res.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                throw new Error("KI-Service antwortet nicht korrekt. Bitte versuche es in 1 Minute erneut.");
            }

            const data = await res.json();
            if (!res.ok) throw new Error(data.details || "Analyse fehlgeschlagen");

            resultsContainer.innerHTML = marked.parse(data.analysis_result);
            resultsContainer.style.display = 'block';
        } catch (error) {
            showStatus(analysisStatus, error.message, true);
        } finally {
            loadingSpinner.style.display = 'none';
        }
    }

    // Kleine Anpassung der Hilfsfunktion f√ºr mehr Flexibilit√§t
    function updateUI(percent, text = "") {
        progressBar.style.width = percent + "%";
        progressBar.innerText = Math.round(percent) + "%";
        if (text) {
            // Optional: Zeige Text unter der Bar an, falls du dort ein <p id="homeLoadingText"> hast
            const textEl = document.getElementById('homeLoadingText');
            if (textEl) textEl.innerText = text;
        }
    }
</script>

</body>
</html>