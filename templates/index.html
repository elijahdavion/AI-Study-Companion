<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study Companion</title>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .section {
            border: 1px solid #ccc;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        h1, h2 { color: #333; }
        
        /* Loading Bar Styles */
        #loadingContainer {
            display: none;
            margin-top: 15px;
        }
        .progress-wrapper {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 4px;
            height: 20px;
            overflow: hidden;
            border: 1px solid #ddd;
        }
        #progressBar {
            width: 0%;
            height: 100%;
            background-color: #4CAF50; /* Green */
            transition: width 0.5s ease;
        }
        #statusText {
            display: block;
            margin-top: 5px;
            font-size: 0.9em;
            color: #555;
        }

        /* Form Elements */
        select, button, input[type="file"] {
            margin-top: 10px;
            padding: 8px;
        }
        button {
            cursor: pointer;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 4px;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        #resultSection { display: none; }
    </style>
</head>
<body>

    <h1>AI Study Companion</h1>

    <!-- Upload Section -->
    <div class="section">
        <h2>1. Upload Document</h2>
        <input type="file" id="fileInput" accept=".pdf">
        <button onclick="handleFileUpload()" id="uploadBtn">Upload</button>

        <!-- The Loading Bar You Requested -->
        <div id="loadingContainer">
            <div class="progress-wrapper">
                <div id="progressBar"></div>
            </div>
            <span id="statusText">Uploading file to cloud...</span>
        </div>
    </div>

    <!-- Analysis Section -->
    <div class="section">
        <h2>2. Analyze Document</h2>
        <label for="fileSelect">Select a document to study:</label><br>
        <select id="fileSelect">
            <option selected disabled>Loading files...</option>
        </select>
        <br>
        <button onclick="analyzeFile()" id="analyzeBtn" style="width: 100%; margin-top: 10px;">Generate Study Guide</button>
    </div>

    <!-- Results Section -->
    <div id="resultSection" class="section">
        <h3>Analysis Result</h3>
        <hr>
        <div id="analysisContent"></div>
        <p style="margin-top: 20px; font-size: 0.9em; color: #666;">
            <strong>Sources:</strong> <span id="sourcesList"></span>
        </p>
    </div>

<script>
    // Load files on page load
    document.addEventListener('DOMContentLoaded', loadFiles);

    async function loadFiles() {
        try {
            const response = await fetch('/files');
            const data = await response.json();
            const select = document.getElementById('fileSelect');
            
            select.innerHTML = '<option selected disabled>Select a file...</option>';
            
            if (data.files && data.files.length > 0) {
                data.files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.path;
                    option.textContent = file.name;
                    select.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = "No files found";
                select.appendChild(option);
            }
        } catch (error) {
            console.error('Error loading files:', error);
        }
    }

    async function handleFileUpload() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) return alert("Please select a PDF file first.");

        // UI: Show Loading
        const container = document.getElementById('loadingContainer');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const uploadBtn = document.getElementById('uploadBtn');

        container.style.display = 'block';
        uploadBtn.disabled = true;
        
        // Step 1: Uploading
        progressBar.style.width = '30%';
        statusText.innerText = "Uploading file to cloud...";

        const formData = new FormData();
        formData.append('file', file);

        try {
            const uploadResponse = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            const uploadData = await uploadResponse.json();

            if (!uploadResponse.ok) throw new Error(uploadData.error || "Upload failed");

            // Step 2: Indexing (Polling)
            progressBar.style.width = '60%';
            statusText.innerText = "Indexing... (This may take a minute)";
            
            await pollForIndex(uploadData.path);

            // Step 3: Success
            progressBar.style.width = '100%';
            statusText.innerText = "Ready! File is indexed and available.";
            uploadBtn.disabled = false;
            
            // Refresh dropdown
            await loadFiles();
            
            // Clear input
            fileInput.value = '';

            // Hide bar after 3 seconds
            setTimeout(() => {
                container.style.display = 'none';
                progressBar.style.width = '0%';
            }, 3000);

        } catch (error) {
            console.error(error);
            progressBar.style.backgroundColor = '#dc3545'; // Red for error
            statusText.innerText = "Error: " + error.message;
            uploadBtn.disabled = false;
        }
    }

    async function pollForIndex(gcsUri) {
        const maxAttempts = 60; // Timeout after ~2 minutes
        let attempts = 0;

        while (attempts < maxAttempts) {
            try {
                const response = await fetch('/check_file_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gcs_uri: gcsUri })
                });
                
                const data = await response.json();
                
                if (response.status === 200 && data.status === 'INDEXED') {
                    return true; // Success
                }
            } catch (e) {
                console.warn("Polling check failed, retrying...", e);
            }
            
            // Wait 2 seconds before next check
            await new Promise(resolve => setTimeout(resolve, 2000));
            attempts++;
        }
        throw new Error("Indexing timed out. The file is taking too long to process.");
    }

    async function analyzeFile() {
        const select = document.getElementById('fileSelect');
        const filePath = select.value;
        
        if (!filePath || filePath.includes("Select a file")) {
            return alert("Please select a file from the list.");
        }

        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultSection = document.getElementById('resultSection');
        const analysisContent = document.getElementById('analysisContent');
        const sourcesList = document.getElementById('sourcesList');

        // UI: Loading State
        analyzeBtn.disabled = true;
        analyzeBtn.innerText = 'Analyzing...';
        resultSection.style.display = 'none';

        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_path: filePath })
            });
            
            const data = await response.json();

            if (!response.ok) throw new Error(data.details || data.error || "Analysis failed");

            // Render Markdown
            analysisContent.innerHTML = marked.parse(data.analysis_result);
            
            // Show Sources
            if (data.used_sources && data.used_sources.length > 0) {
                sourcesList.innerText = data.used_sources.join(', ');
            } else {
                sourcesList.innerText = "No specific sources cited.";
            }

            resultSection.style.display = 'block';

        } catch (error) {
            alert("Error during analysis: " + error.message);
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.innerText = "Generate Study Guide";
        }
    }
</script>

</body>
</html>
