<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Study Companion</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        .progress-bar {
            transition: width 0.5s ease;
        }
        .analysis-content h2 {
            margin-top: 1.5rem;
            font-size: 1.5rem;
            border-bottom: 2px solid #dee2e6;
            padding-bottom: 0.5rem;
        }
        .analysis-content ul {
            margin-bottom: 1rem;
        }
    </style>
</head>
<body class="bg-light">

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <h1 class="text-center mb-4">AI Study Companion</h1>

            <!-- Upload Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">1. Upload Document</h5>
                </div>
                <div class="card-body">
                    <div class="input-group mb-3">
                        <input type="file" class="form-control" id="fileInput" accept=".pdf">
                        <button class="btn btn-primary" type="button" onclick="handleFileUpload()" id="uploadBtn">Upload</button>
                    </div>

                    <!-- Loading Bar & Status -->
                    <div id="uploadStatusContainer" style="display: none;">
                        <div class="progress mb-2" style="height: 20px;">
                            <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <small id="statusText" class="text-muted">Initializing...</small>
                            <div id="spinner" class="spinner-border spinner-border-sm text-primary" role="status" style="display:none;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Section -->
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">2. Analyze Document</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="fileSelect" class="form-label">Select a document to study:</label>
                        <select class="form-select" id="fileSelect">
                            <option selected disabled>Loading files...</option>
                        </select>
                    </div>
                    <button class="btn btn-success w-100" onclick="analyzeFile()" id="analyzeBtn">Generate Study Guide</button>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultSection" class="mt-4" style="display: none;">
                <div class="card shadow-sm">
                    <div class="card-body">
                        <h4 class="card-title">Analysis Result</h4>
                        <hr>
                        <div id="analysisContent" class="analysis-content"></div>
                        <div class="mt-3">
                            <small class="text-muted"><strong>Sources:</strong> <span id="sourcesList"></span></small>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // Load files on page load
    document.addEventListener('DOMContentLoaded', loadFiles);

    async function loadFiles() {
        try {
            const response = await fetch('/files');
            const data = await response.json();
            const select = document.getElementById('fileSelect');
            
            select.innerHTML = '<option selected disabled>Select a file...</option>';
            
            if (data.files && data.files.length > 0) {
                data.files.forEach(file => {
                    const option = document.createElement('option');
                    option.value = file.path;
                    option.textContent = file.name;
                    select.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.disabled = true;
                option.textContent = "No files found";
                select.appendChild(option);
            }
        } catch (error) {
            console.error('Error loading files:', error);
        }
    }

    async function handleFileUpload() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) return alert("Please select a PDF file first.");

        // UI: Reset and Show Loading
        const container = document.getElementById('uploadStatusContainer');
        const progressBar = document.getElementById('progressBar');
        const statusText = document.getElementById('statusText');
        const spinner = document.getElementById('spinner');
        const uploadBtn = document.getElementById('uploadBtn');

        container.style.display = 'block';
        spinner.style.display = 'block';
        uploadBtn.disabled = true;
        
        // Step 1: Uploading
        progressBar.style.width = '30%';
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
        statusText.innerText = "Uploading file to cloud...";

        const formData = new FormData();
        formData.append('file', file);

        try {
            const uploadResponse = await fetch('/upload', {
                method: 'POST',
                body: formData
            });
            const uploadData = await uploadResponse.json();

            if (!uploadResponse.ok) throw new Error(uploadData.error || "Upload failed");

            // Step 2: Indexing (Polling)
            progressBar.style.width = '60%';
            statusText.innerText = "Indexing... (This may take a minute)";
            
            await pollForIndex(uploadData.path);

            // Step 3: Success
            progressBar.style.width = '100%';
            progressBar.className = 'progress-bar bg-success';
            statusText.innerText = "Ready! File is indexed and available.";
            spinner.style.display = 'none';
            uploadBtn.disabled = false;
            
            // Refresh dropdown
            await loadFiles();
            
            // Clear input
            fileInput.value = '';

            // Hide bar after 3 seconds
            setTimeout(() => {
                container.style.display = 'none';
                progressBar.style.width = '0%';
            }, 3000);

        } catch (error) {
            console.error(error);
            progressBar.className = 'progress-bar bg-danger';
            statusText.innerText = "Error: " + error.message;
            spinner.style.display = 'none';
            uploadBtn.disabled = false;
        }
    }

    async function pollForIndex(gcsUri) {
        const maxAttempts = 60; // Timeout after ~2 minutes
        let attempts = 0;

        while (attempts < maxAttempts) {
            try {
                const response = await fetch('/check_file_status', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ gcs_uri: gcsUri })
                });
                
                const data = await response.json();
                
                if (response.status === 200 && data.status === 'INDEXED') {
                    return true; // Success
                }
            } catch (e) {
                console.warn("Polling check failed, retrying...", e);
            }
            
            // Wait 2 seconds before next check
            await new Promise(resolve => setTimeout(resolve, 2000));
            attempts++;
        }
        throw new Error("Indexing timed out. The file is taking too long to process.");
    }

    async function analyzeFile() {
        const select = document.getElementById('fileSelect');
        const filePath = select.value;
        
        if (!filePath || filePath.includes("Select a file")) {
            return alert("Please select a file from the list.");
        }

        const analyzeBtn = document.getElementById('analyzeBtn');
        const resultSection = document.getElementById('resultSection');
        const analysisContent = document.getElementById('analysisContent');
        const sourcesList = document.getElementById('sourcesList');

        // UI: Loading State
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...';
        resultSection.style.display = 'none';

        try {
            const response = await fetch('/analyze', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ file_path: filePath })
            });
            
            const data = await response.json();

            if (!response.ok) throw new Error(data.details || data.error || "Analysis failed");

            // Render Markdown
            analysisContent.innerHTML = marked.parse(data.analysis_result);
            
            // Show Sources
            if (data.used_sources && data.used_sources.length > 0) {
                sourcesList.innerText = data.used_sources.join(', ');
            } else {
                sourcesList.innerText = "No specific sources cited.";
            }

            resultSection.style.display = 'block';

        } catch (error) {
            alert("Error during analysis: " + error.message);
        } finally {
            analyzeBtn.disabled = false;
            analyzeBtn.innerText = "Generate Study Guide";
        }
    }
</script>

</body>
</html>
